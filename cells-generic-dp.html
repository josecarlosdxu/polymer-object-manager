<link rel="import" href="../bower_components/polymer/polymer-element.html">
<dom-module id="cells-generic-dp">
  <template>
      <style>
      .loading {
        display: flex;
        position: fixed;
        top: 0;
        left: 0;
        z-index: 10;
        width: 100vw;
        height: 100%;
        align-items: center;
        justify-content: center; 
        font-size: 1.5em;
        background-color: rgba(100, 100, 100, 0.8);
        color: white;
        opacity: 0;
        animation: fadein 0.5s ease-out forwards;   
      }

      .loading[hidden] {
        opacity: 1;
        animation: fadeout 0.2s ease-in forwards;
        pointer-events: none;       
      }

      @keyframes fadein {
        from {
          opacity: 0;          
        }
        to {          
          opacity: 1;
        }
      }

      @keyframes fadeout {
        from {
          opacity: 1;          
        }
        to {          
          opacity: 0;
        }
      }

    </style>
    <p class="loading" hidden$="[[isLoaded]]">[[message]]</p>
   
  </template>
  <script>
    class CellsGenericDp extends Polymer.Element {

      static get is() {
        return "cells-generic-dp";
      }

      static get properties() {
        return {
          host: {
            type :String
          },
          path: {
            type :String
          },
          params:{
            type: String,           
            value: ''                 
          },          
          headers: String, 
          body: String,
          method: String,

          _requestURL: {
            type: String,
            notify:true,
            computed: '_getURL(host, path, params)'
            
          },
          isLoaded:{
            type: Boolean,
            notify:true
          },
          message: String
        };
      }

      
      constructor() {
        super();
        this.headers = '';        
        this.method ='GET';
        this.message = 'loading...'; 
        this.isLoaded = false;      
      }

      ready() {
        super.ready();       
      }

      connectedCallback() {
        super.connectedCallback();
        this.generateRequest();        
      }

      _getURL(host, path, params){
        return  host + path + params;         
      }

      _handleStatus(response) {
          if (!response.ok) {
              this._eventDispatcher('fetch', response.statusText);
              throw Error(response.statusText);
          }
          return response;
      }

      _handleResponse(data) {
        this._eventDispatcher('request-success', data); 
        this.message = 'request success'; 
      }

       _handleError(error) { 
        this._eventDispatcher('request-error', error);
        this.message = 'request-error ';
      }

      generateRequest() {
        this.isLoaded = false;
        const myHeaders = new Headers();
        myHeaders.append('Access-Control-Allow-Origin', '*');
        const myInit = { 
              method: this.method,
               headers: myHeaders,
               mode: 'cors',
               cache: 'default' 
        };
        const request = new Request(this._requestURL, myInit);
        fetch(request)
        .then(this._handleStatus)
        .then(response => response.json())
        .then(response => this._handleResponse(response) )
        .catch(error =>  this._handleError(error));
      } 


     _eventDispatcher(type, data) {
        this.dispatchEvent(new CustomEvent(type, {
          detail: {data},
          bubbles: true,
          composed: true
        }));
        this.isLoaded = true;
      } 
    }

    customElements.define(CellsGenericDp.is, CellsGenericDp);
  </script>
</dom-module>